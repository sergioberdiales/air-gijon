services:
  - type: web
    name: air-gijon
    env: node
    plan: free
    buildCommand: npm install
    startCommand: npm start
    healthCheckPath: /
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: air-gijon-db
          property: connectionString
      - fromGroup: air-gijon-env

  # Cron job para actualizar datos cada hora
  - type: cron
    name: data-update
    env: node
    schedule: "0 * * * *"  # Cada hora en punto
    buildCommand: npm install
    startCommand: npm run update-aqicn
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: air-gijon-db
          property: connectionString
      - fromGroup: air-gijon-env

  # Cron job para enviar predicciones diarias
  - type: cron
    name: email-predictions
    env: node
    schedule: "0 6 * * *"  # Todos los días a las 6:00 AM UTC (8:00 AM España)
    buildCommand: npm install
    startCommand: node scripts/cron/send_daily_predictions.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: air-gijon-db
          property: connectionString
      - fromGroup: air-gijon-env

  # Cron job para alertas de PM2.5 alto
  - type: cron
    name: email-alerts
    env: node
    schedule: "5 * * * *"  # Cada hora a los 5 min (evitar conflicto con datos)
    buildCommand: npm install
    startCommand: node scripts/cron/send_hourly_alerts.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: air-gijon-db
          property: connectionString
      - fromGroup: air-gijon-env

databases:
  - name: air-gijon-db
    databaseName: air_gijon
    user: air_gijon_user 